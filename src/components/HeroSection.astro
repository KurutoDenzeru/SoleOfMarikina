---
import { MoveLeft, MapPin } from "lucide-react";
import MobileTopNavbar from "@/components/MobileTopNavbar.astro";
import StoreDetailCards from "@/components/StoreDetailCards.astro";
import {
  landingCards,
  storeOrder,
  stores as storeData,
} from "@/lib/store-pages";

type StoreMapItem = {
  id: string;
  label: string;
  address: string;
  top: string;
  left: string;
  pinSide: "left" | "right";
  cards: { title: string; href?: string }[];
};

const stores: StoreMapItem[] = storeData
  .map((store) => ({
    id: store.slug,
    label: store.name,
    address: store.address,
    top: store.mapTop,
    left: store.mapLeft,
    pinSide: store.mapPinSide,
    cards: landingCards(store.slug),
  }))
  .sort((a, b) => storeOrder.indexOf(a.id) - storeOrder.indexOf(b.id));

const navLinks = [
  { label: "Home", href: "/" },
  { label: "Stores", href: "/stores" },
  { label: "About", href: "/about" },
  { label: "Contact", href: "/contact" },
];

const currentPath = Astro.url.pathname.replace(/\/+$/, "") || "/";
const defaultMapBackground = "/map/marikina.png";
---

<section class="relative w-full">
  <button
    id="menu-overlay"
    type="button"
    aria-label="Close menu"
    aria-hidden="true"
    class="pointer-events-none fixed inset-0 z-40 bg-transparent backdrop-blur-sm opacity-0 transition-opacity duration-300 ease-out"
  ></button>

  <aside
    id="mobile-sidebar"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    aria-labelledby="mobile-sidebar-title"
    class="fixed left-0 top-0 z-50 flex h-full w-[71%] max-w-85 -translate-x-full flex-col bg-black/90 px-6 py-6 text-white shadow-2xl transition-transform duration-300 ease-out"
  >
    <h2 id="mobile-sidebar-title" class="sr-only">Main navigation</h2>
    <div class="mb-16 flex items-center justify-start">
      <button
        id="menu-close"
        type="button"
        aria-label="Close navigation menu"
        class="inline-flex rounded-md p-1 text-white/95 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white"
      >
        <MoveLeft className="size-8" />
      </button>
    </div>

    <nav aria-label="Main navigation" class="mt-1">
      <ul class="space-y-7">
        {
          navLinks.map((link) => {
            const linkPath = link.href.replace(/\/+$/, "") || "/";
            const isActive = currentPath === linkPath;
            return (
              <li>
                <a
                  href={link.href}
                  aria-current={isActive ? "page" : undefined}
                  class:list={[
                    "block px-2 py-0 text-[3rem] leading-none tracking-tight focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white",
                    isActive
                      ? "font-bold text-white"
                      : "font-extralight text-stone-200",
                  ]}
                >
                  {link.label}
                </a>
              </li>
            );
          })
        }
      </ul>
    </nav>
  </aside>

  <article
    class="relative min-h-screen w-full overflow-x-clip bg-[#d8ae73] bg-cover bg-top bg-no-repeat sm:bg-center"
    style={`background-image:url('${defaultMapBackground}');`}
  >
    <MobileTopNavbar
      leftAction={{
        type: "button",
        icon: "menu",
        ariaLabel: "Open navigation menu",
        id: "menu-toggle",
        controls: "mobile-sidebar",
        expanded: "false",
        className: "rounded-md",
      }}
      rightAction={{
        type: "button",
        icon: "search",
        ariaLabel: "Search stores",
        className: "rounded-md",
      }}
      centerImageSrc="/Logo/brand.webp"
      centerImageAlt="Sole of Marikina"
      centerImageClass="h-16 w-auto max-w-[220px] object-contain sm:h-22 sm:max-w-[260px]"
    />

    <div class="relative z-20 min-h-[calc(100svh-7rem)]">
      <button
        id="store-backdrop"
        type="button"
        aria-label="Close store details"
        class="pointer-events-none absolute inset-0 z-25 bg-transparent"
      ></button>

      <div id="store-trigger-layer" class="absolute inset-0 z-20 transition-all duration-300 ease-out">
        {
          stores.map((store) => (
            <div
              class="absolute inline-flex -translate-x-1/2 -translate-y-1/2 items-center gap-2"
              style={`top:${store.top};left:${store.left};`}
            >
              {store.pinSide === "left" && (
                <MapPin className="size-8 shrink-0 text-black" />
              )}
              <button
                type="button"
                data-store-trigger={store.id}
                aria-controls={`store-panel-${store.id}`}
                aria-expanded="false"
                aria-pressed="false"
                class="cursor-pointer rounded-full bg-black px-5 py-1.5 text-md leading-none font-semibold tracking-tight whitespace-nowrap text-white transition-all duration-300 ease-out hover:-translate-y-0.5 hover:shadow-[0_8px_18px_rgba(0,0,0,0.35)] active:translate-y-0 active:scale-[0.97] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-black/70 touch-manipulation sm:px-6 sm:text-[17px]"
              >
                {store.label}
              </button>
              {store.pinSide === "right" && (
                <MapPin className="size-8 shrink-0 text-black" />
              )}
            </div>
          ))
        }
      </div>

      {
        stores.map((store) => (
          <StoreDetailCards
            storeId={store.id}
            storeName={store.label}
            address={store.address}
            cards={store.cards}
          />
        ))
      }
    </div>
  </article>
</section>

<script is:inline>
  (() => {
    if (window.__somHeroBindingsInitialized) return;
    window.__somHeroBindingsInitialized = true;

    let cleanup = () => {};

    const init = () => {
      cleanup();

      const openButton = document.getElementById("menu-toggle");
      const closeButton = document.getElementById("menu-close");
      const overlay = document.getElementById("menu-overlay");
      const sidebar = document.getElementById("mobile-sidebar");
      const storeBackdrop = document.getElementById("store-backdrop");
      const storeTriggerLayer = document.getElementById("store-trigger-layer");
      if (!openButton || !closeButton || !overlay || !sidebar) return;

      let lastFocused = null;
      let activeStoreId = null;

      const isOpen = () => openButton.getAttribute("aria-expanded") === "true";
      const getFocusable = () =>
        sidebar.querySelectorAll("a[href], button:not([disabled])");
      const storeTriggers = Array.from(document.querySelectorAll("[data-store-trigger]"));
      const storePanels = Array.from(document.querySelectorAll("[data-store-panel]"));

      const closeStorePanels = () => {
        activeStoreId = null;
        storeTriggers.forEach((trigger) => {
          trigger.setAttribute("aria-expanded", "false");
          trigger.setAttribute("aria-pressed", "false");
          trigger.classList.remove("scale-105", "ring-2", "ring-white/80");
        });

        storePanels.forEach((panel) => {
          panel.setAttribute("aria-hidden", "true");
          panel.classList.remove(
            "opacity-100",
            "translate-y-0",
            "scale-100",
            "pointer-events-auto"
          );
          panel.classList.add(
            "opacity-0",
            "translate-y-8",
            "scale-95",
            "pointer-events-none"
          );
        });

        if (storeBackdrop) {
          storeBackdrop.classList.add("pointer-events-none");
        }

        if (storeTriggerLayer) {
          storeTriggerLayer.classList.remove(
            "opacity-0",
            "pointer-events-none",
            "translate-y-1"
          );
          storeTriggerLayer.classList.add("opacity-100");
        }
      };

      const openMenu = () => {
        lastFocused = document.activeElement;
        openButton.setAttribute("aria-expanded", "true");
        sidebar.classList.remove("-translate-x-full");
        sidebar.classList.add("translate-x-0");
        sidebar.setAttribute("aria-hidden", "false");
        overlay.classList.remove("opacity-0", "pointer-events-none");
        overlay.classList.add("opacity-100", "bg-black/30");
        document.body.classList.add("overflow-hidden");

        const firstFocusable = getFocusable()[0];
        if (firstFocusable instanceof HTMLElement) firstFocusable.focus();
      };

      const closeMenu = () => {
        openButton.setAttribute("aria-expanded", "false");
        sidebar.classList.remove("translate-x-0");
        sidebar.classList.add("-translate-x-full");
        sidebar.setAttribute("aria-hidden", "true");
        overlay.classList.remove("opacity-100", "bg-black/30");
        overlay.classList.add("opacity-0", "pointer-events-none");
        document.body.classList.remove("overflow-hidden");

        if (lastFocused instanceof HTMLElement) lastFocused.focus();
      };

      const openStorePanel = (storeId, triggerEl) => {
        const targetPanel = storePanels.find(
          (panel) => panel.getAttribute("data-store-panel") === storeId
        );
        if (!targetPanel) return;

        activeStoreId = storeId;
        storeTriggers.forEach((trigger) => {
          const isTarget = trigger.getAttribute("data-store-trigger") === storeId;
          trigger.setAttribute("aria-expanded", isTarget ? "true" : "false");
          trigger.setAttribute("aria-pressed", isTarget ? "true" : "false");
          trigger.classList.toggle("scale-105", isTarget);
          trigger.classList.toggle("ring-2", isTarget);
          trigger.classList.toggle("ring-white/80", isTarget);
        });

        storePanels.forEach((panel) => {
          const isTarget = panel === targetPanel;
          panel.setAttribute("aria-hidden", isTarget ? "false" : "true");
          panel.classList.toggle("opacity-100", isTarget);
          panel.classList.toggle("translate-y-0", isTarget);
          panel.classList.toggle("scale-100", isTarget);
          panel.classList.toggle("pointer-events-auto", isTarget);
          panel.classList.toggle("opacity-0", !isTarget);
          panel.classList.toggle("translate-y-8", !isTarget);
          panel.classList.toggle("scale-95", !isTarget);
          panel.classList.toggle("pointer-events-none", !isTarget);
        });

        if (storeBackdrop) {
          storeBackdrop.classList.remove("pointer-events-none");
        }

        if (storeTriggerLayer) {
          storeTriggerLayer.classList.remove("opacity-100");
          storeTriggerLayer.classList.add(
            "opacity-0",
            "pointer-events-none",
            "translate-y-1"
          );
        }

        const panelRect = targetPanel.getBoundingClientRect();
        const triggerRect = triggerEl.getBoundingClientRect();
        const startX =
          triggerRect.left +
          triggerRect.width / 2 -
          (panelRect.left + panelRect.width / 2);
        const startY =
          triggerRect.top + triggerRect.height / 2 - (panelRect.top + 24);

        targetPanel.animate(
          [
            {
              opacity: 0,
              transform: `translate(${startX * 0.28}px, ${startY * 0.28}px) scale(0.82)`,
            },
            {
              opacity: 1,
              transform: "translate(0, 0) scale(1)",
            },
          ],
          {
            duration: 460,
            easing: "cubic-bezier(0.2, 0.75, 0.2, 1)",
          }
        );

        targetPanel.querySelectorAll("[data-store-card]").forEach((card, index) => {
          card.animate(
            [
              { opacity: 0, transform: "translateY(30px) scale(0.95)" },
              { opacity: 1, transform: "translateY(0) scale(1)" },
            ],
            {
              duration: 420,
              delay: 90 + index * 70,
              easing: "cubic-bezier(0.2, 0.75, 0.2, 1)",
              fill: "both",
            }
          );
        });
      };

      const onDocumentKeydown = (event) => {
        if (event.key !== "Escape") return;
        if (isOpen()) {
          closeMenu();
          return;
        }
        closeStorePanels();
      };

      const onSidebarKeydown = (event) => {
        if (!isOpen() || event.key !== "Tab") return;
        const focusable = Array.from(getFocusable());
        if (!focusable.length) return;

        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (!(first instanceof HTMLElement) || !(last instanceof HTMLElement)) return;

        if (event.shiftKey && document.activeElement === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      };

      const triggerHandlers = storeTriggers.map((trigger) => {
        const onTriggerClick = () => {
          const storeId = trigger.getAttribute("data-store-trigger");
          if (!storeId) return;

          if (activeStoreId === storeId) {
            closeStorePanels();
            return;
          }
          openStorePanel(storeId, trigger);
        };

        trigger.addEventListener("click", onTriggerClick);
        return { trigger, onTriggerClick };
      });

      const sidebarLinks = Array.from(sidebar.querySelectorAll("a[href]"));
      sidebarLinks.forEach((link) => link.addEventListener("click", closeMenu));

      openButton.addEventListener("click", openMenu);
      closeButton.addEventListener("click", closeMenu);
      overlay.addEventListener("click", closeMenu);
      document.addEventListener("keydown", onDocumentKeydown);
      sidebar.addEventListener("keydown", onSidebarKeydown);
      if (storeBackdrop) {
        storeBackdrop.addEventListener("click", closeStorePanels);
      }

      closeMenu();
      closeStorePanels();

      cleanup = () => {
        document.body.classList.remove("overflow-hidden");
        openButton.removeEventListener("click", openMenu);
        closeButton.removeEventListener("click", closeMenu);
        overlay.removeEventListener("click", closeMenu);
        document.removeEventListener("keydown", onDocumentKeydown);
        sidebar.removeEventListener("keydown", onSidebarKeydown);
        sidebarLinks.forEach((link) => link.removeEventListener("click", closeMenu));
        if (storeBackdrop) {
          storeBackdrop.removeEventListener("click", closeStorePanels);
        }
        triggerHandlers.forEach(({ trigger, onTriggerClick }) => {
          trigger.removeEventListener("click", onTriggerClick);
        });
      };
    };

    init();
    document.addEventListener("astro:page-load", init);
  })();
</script>
